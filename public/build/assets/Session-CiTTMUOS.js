import{r as ve,j as s,c as $e,b as Ie,u as Ke,H as ze,L as Qe}from"./app-XPqbswjP.js";import{b as ye}from"./base44Client-D_8p-kpS.js";import{B as ee,t as qe}from"./index-OjgNDduT.js";import{D as Pe,a as Ve,b as Ge,c as Je,d as We,e as Xe}from"./dialog-Bfaowtgw.js";import{L as Me,I as Ye}from"./label-ohV488kT.js";import{T as Ze}from"./textarea-D7JmwleY.js";import{B as Ce}from"./badge-BZemhbWI.js";import{C as Ue,a as Ae,b as _e,c as we}from"./card-C8bUzc1h.js";import{T as Ee,a as te,b as es,c as Ne,d as ss,e as ts}from"./table-Dc3gysDx.js";import{A as Oe,U as ls}from"./app-main-p7Td2XQe.js";import{u as He}from"./users-3glLT9eq.js";import{h as Le}from"./moment-B-YVwB4U.js";import{H as as}from"./history-BWAKxt8y.js";import{A as rs}from"./arrow-left-DsqDSJSh.js";import{L as is}from"./lock-open-42mnpy67.js";import{L as ns}from"./lock-zW8xBJEF.js";import{B as os}from"./banknote-DZHlm-di.js";import{C as cs}from"./clock-hY7Azrf4.js";import{C as ds}from"./circle-check-DZMMeG0N.js";import{T as ms}from"./triangle-alert-DRDAnFip.js";/* empty css            */import"./axios-G5n3UMvP.js";import"./createLucideIcon-CscEagRl.js";const xs=["USD","CDF","EUR"];function hs({session:l,isOpen:e,onClose:a,onSuccess:y}){const[_,se]=ve.useState(!1),[x,t]=ve.useState({USD:"0",CDF:"0",EUR:"0"}),[le,h]=ve.useState(""),u=async r=>{if(r.preventDefault(),!!l&&confirm("Êtes-vous sûr de vouloir clôturer cette caisse ? Cette action est irréversible.")){se(!0);try{await ye.entities.CashSession.close(l.id,{closing_amounts:x,notes:le}),qe.success("Session clôturée avec succès"),y(),a()}catch(f){qe.error(f.response?.data?.message||"Erreur lors de la clôture")}finally{se(!1)}}};return s.jsx(Pe,{open:e,onOpenChange:a,children:s.jsxs(Ve,{className:"sm:max-w-[425px]",children:[s.jsxs(Ge,{children:[s.jsx(Je,{children:"Clôture de Caisse"}),s.jsxs(We,{children:["Veuillez compter et saisir le solde RÉEL pour la session #",l?.id,". Tout écart sera enregistré."]})]}),s.jsxs("form",{onSubmit:u,className:"grid gap-4 py-4",children:[s.jsx("div",{className:"grid gap-4",children:xs.map(r=>s.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[s.jsx(Me,{htmlFor:`close-amount-${r}`,className:"text-right font-bold",children:r}),s.jsx(Ye,{id:`close-amount-${r}`,type:"number",min:"0",step:"0.01",value:x[r],onChange:f=>t({...x,[r]:f.target.value}),className:"col-span-3"})]},r))}),s.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[s.jsx(Me,{htmlFor:"close-notes",className:"text-right",children:"Notes"}),s.jsx(Ze,{id:"close-notes",value:le,onChange:r=>h(r.target.value),className:"col-span-3",placeholder:"Remarques sur la clôture..."})]}),s.jsxs(Xe,{children:[s.jsx(ee,{type:"button",variant:"outline",onClick:a,children:"Annuler"}),s.jsx(ee,{type:"submit",variant:"destructive",disabled:_,children:_?"Clôture...":"Clôturer la Caisse"})]})]})]})})}function Ks(l){const e=$e.c(129),{id:a}=l;Ie();const y=Ke(),[_,se]=ve.useState(!1);let x;e[0]!==a?(x={queryKey:["cash-session",a],queryFn:()=>ye.entities.CashSession.show(a)},e[0]=a,e[1]=x):x=e[1];const{data:t,isLoading:le}=He(x);let h,u;e[2]!==a?(h=["cash-movements",a],u=async()=>(await ye.entities.CashSession.movements(a)).data,e[2]=a,e[3]=h,e[4]=u):(h=e[3],u=e[4]);const r=!!t;let f;e[5]!==h||e[6]!==u||e[7]!==r?(f={queryKey:h,queryFn:u,enabled:r},e[5]=h,e[6]=u,e[7]=r,e[8]=f):f=e[8];const{data:ae}=He(f);let re;e[9]!==ae?(re=ae===void 0?[]:ae,e[9]=ae,e[10]=re):re=e[10];const o=re;let w,C;e[11]!==a?(w=["cash-session-report",a],C=()=>ye.entities.CashSession.report(a),e[11]=a,e[12]=w,e[13]=C):(w=e[12],C=e[13]);const Se=!!t;let ie;e[14]!==Se||e[15]!==w||e[16]!==C?(ie={queryKey:w,queryFn:C,enabled:Se},e[14]=Se,e[15]=w,e[16]=C,e[17]=ie):ie=e[17],He(ie);let ne;e[18]!==a||e[19]!==y?(ne=()=>{y.invalidateQueries({queryKey:["cash-session",a]}),y.invalidateQueries({queryKey:["cash-registers"]})},e[18]=a,e[19]=y,e[20]=ne):ne=e[20];const ke=ne;if(le||!t){let n;return e[21]===Symbol.for("react.memo_cache_sentinel")?(n=s.jsx(Oe,{currentPageName:"CashMoney",children:s.jsx("div",{className:"flex h-screen items-center justify-center",children:"Chargement..."})}),e[21]=n):n=e[21],n}const i=t.status==="open";let oe;e[22]!==i||e[23]!==o||e[24]!==t.amounts?(oe=n=>{const U=t.amounts?.find(v=>v.currency===n);if(!U)return null;const A=parseFloat(U.opening_amount),c=U.closing_amount_real?parseFloat(U.closing_amount_real):null,N=o.filter(v=>v.currency===n),d=N.filter(gs).reduce(js,0),O=N.filter(bs).reduce(ps,0),B=A+d-O,m=c!==null?c-B:null;return{currency:n,opening:A,totalIn:d,totalOut:O,theoretical:B,closingReal:c,difference:m,status:!i&&c!==null?Math.abs(m)<.01?"perfect":"mismatch":"pending"}},e[22]=i,e[23]=o,e[24]=t.amounts,e[25]=oe):oe=e[25];const Fe=oe;let S,k,F,T,p,b,j,R,g;if(e[26]!==Fe||e[27]!==i||e[28]!==t.closed_at||e[29]!==t.id||e[30]!==t.opened_at||e[31]!==t.register?.name||e[32]!==t.register?.shop?.name||e[33]!==t.user?.name||e[34]!==t.user_id){const U=["USD","CDF","EUR"].map(Be=>Fe(Be)).filter(Boolean);S=Oe,R="CashMoney";const A=`Session #${t.id}`;e[44]!==A?(g=s.jsx(ze,{title:A}),e[44]=A,e[45]=g):g=e[45],T="min-h-screen bg-gradient-to-br from-slate-50 via-white to-pink-50/30 px-6 py-8 md:px-10";let c,N;e[46]===Symbol.for("react.memo_cache_sentinel")?(c=s.jsx(Qe,{href:"/cash/dashboard",children:s.jsx(ee,{variant:"ghost",size:"icon",className:"h-12 w-12 rounded-2xl border border-white/40 bg-white/50 shadow-sm backdrop-blur-md hover:bg-white/80",children:s.jsx(rs,{className:"h-5 w-5 text-pink-600"})})}),N=s.jsx("div",{className:"h-10 w-[1px] bg-pink-100"}),e[46]=c,e[47]=N):(c=e[46],N=e[47]);let d;e[48]!==t.id?(d=s.jsxs("h1",{className:"text-xl font-black tracking-tight text-slate-900",children:["Session #",t.id]}),e[48]=t.id,e[49]=d):d=e[49];const O=i?"default":"secondary",B=i?"bg-green-500 hover:bg-green-600":"bg-slate-200 text-slate-600";let m;e[50]!==i?(m=i?s.jsx(is,{className:"mr-1 h-3 w-3"}):s.jsx(ns,{className:"mr-1 h-3 w-3"}),e[50]=i,e[51]=m):m=e[51];const v=i?"OUVERTE":"CLÔTURÉE";let $;e[52]!==O||e[53]!==B||e[54]!==m||e[55]!==v?($=s.jsxs(Ce,{variant:O,className:B,children:[m,v]}),e[52]=O,e[53]=B,e[54]=m,e[55]=v,e[56]=$):$=e[56];let I;e[57]!==d||e[58]!==$?(I=s.jsxs("div",{className:"flex items-center gap-2",children:[d,$]}),e[57]=d,e[58]=$,e[59]=I):I=e[59];const Te=t.register?.name,Re=t.register?.shop?.name;let K;e[60]!==Te||e[61]!==Re?(K=s.jsxs("p",{className:"text-xs font-bold text-pink-500 uppercase",children:[Te," •"," ",Re]}),e[60]=Te,e[61]=Re,e[62]=K):K=e[62];let z;e[63]!==I||e[64]!==K?(z=s.jsxs("div",{className:"flex items-center gap-4",children:[c,N,s.jsxs("div",{className:"flex flex-col",children:[I,K]})]}),e[63]=I,e[64]=K,e[65]=z):z=e[65];let Q;e[66]!==i?(Q=i&&s.jsxs(s.Fragment,{children:[s.jsxs(ee,{className:"h-11 rounded-xl bg-white text-slate-700 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50",children:[s.jsx(os,{className:"mr-2 h-4 w-4"}),"Ajouter Mouvement"]}),s.jsx(ee,{onClick:()=>se(!0),className:"h-11 rounded-xl bg-gradient-to-r from-pink-600 to-rose-600 font-bold text-white shadow-lg shadow-pink-500/30 hover:shadow-xl",children:"Clôturer la Session"})]}),e[66]=i,e[67]=Q):Q=e[67];let P;e[68]!==Q?(P=s.jsx("div",{className:"flex items-center gap-3",children:Q}),e[68]=Q,e[69]=P):P=e[69],e[70]!==z||e[71]!==P?(p=s.jsxs("header",{className:"sticky top-0 z-50 mb-10 flex h-24 w-full flex-col gap-6 border-b border-white/20 bg-white/70 px-6 py-4 shadow-sm backdrop-blur-xl md:flex-row md:items-center md:justify-between md:px-10",children:[z,P]}),e[70]=z,e[71]=P,e[72]=p):p=e[72];let he;e[73]===Symbol.for("react.memo_cache_sentinel")?(he=s.jsx(Ue,{className:"pb-2",children:s.jsx(Ae,{className:"text-sm font-bold text-slate-400 uppercase",children:"Responsable"})}),e[73]=he):he=e[73];let ue;e[74]===Symbol.for("react.memo_cache_sentinel")?(ue=s.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-2xl bg-indigo-50 text-indigo-600",children:s.jsx(ls,{className:"h-6 w-6"})}),e[74]=ue):ue=e[74];const De=t.user?.name||`User #${t.user_id}`;let V;e[75]!==De?(V=s.jsx("p",{className:"font-black text-slate-900",children:De}),e[75]=De,e[76]=V):V=e[76];let fe;e[77]===Symbol.for("react.memo_cache_sentinel")?(fe=s.jsx("p",{className:"text-xs font-bold text-slate-400",children:"Caissier"}),e[77]=fe):fe=e[77];let G;e[78]!==V?(G=s.jsxs(_e,{className:"rounded-3xl border-slate-200/60 shadow-sm",children:[he,s.jsx(we,{children:s.jsxs("div",{className:"flex items-center gap-4",children:[ue,s.jsxs("div",{children:[V,fe]})]})})]}),e[78]=V,e[79]=G):G=e[79];let pe;e[80]===Symbol.for("react.memo_cache_sentinel")?(pe=s.jsx(Ue,{className:"pb-2",children:s.jsx(Ae,{className:"text-sm font-bold text-slate-400 uppercase",children:"Horaire"})}),e[80]=pe):pe=e[80];let be;e[81]===Symbol.for("react.memo_cache_sentinel")?(be=s.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-2xl bg-blue-50 text-blue-600",children:s.jsx(cs,{className:"h-6 w-6"})}),e[81]=be):be=e[81];let J;e[82]!==t.opened_at?(J=Le(t.opened_at).format("HH:mm"),e[82]=t.opened_at,e[83]=J):J=e[83];let W;e[84]!==J?(W=s.jsx("p",{className:"font-bold text-slate-900",children:J}),e[84]=J,e[85]=W):W=e[85];let je;e[86]===Symbol.for("react.memo_cache_sentinel")?(je=s.jsx("p",{className:"text-xs font-bold text-slate-400",children:"Ouverture"}),e[86]=je):je=e[86];let X;e[87]!==W?(X=s.jsxs("div",{children:[W,je]}),e[87]=W,e[88]=X):X=e[88];let Y;e[89]!==t.closed_at?(Y=t.closed_at&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"h-8 w-[1px] bg-slate-100"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-bold text-slate-900",children:Le(t.closed_at).format("HH:mm")}),s.jsx("p",{className:"text-xs font-bold text-slate-400",children:"Fermeture"})]})]}),e[89]=t.closed_at,e[90]=Y):Y=e[90];let Z;e[91]!==X||e[92]!==Y?(Z=s.jsxs(_e,{className:"rounded-3xl border-slate-200/60 shadow-sm",children:[pe,s.jsx(we,{children:s.jsxs("div",{className:"flex items-center gap-4",children:[be,X,Y]})})]}),e[91]=X,e[92]=Y,e[93]=Z):Z=e[93];let ge;e[94]===Symbol.for("react.memo_cache_sentinel")?(ge=s.jsx(_e,{className:"col-span-2 rounded-3xl border-slate-200/60 bg-slate-900 text-white shadow-sm",children:s.jsxs(we,{className:"flex h-full items-center justify-between p-6",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-black",children:"Besoin d'aide ?"}),s.jsx("p",{className:"text-sm text-slate-400",children:"Contactez un manager si vous constatez une erreur."})]}),s.jsx(ee,{variant:"outline",className:"border-slate-700 bg-slate-800 text-white hover:bg-slate-700 hover:text-white",children:"Signaler un problème"})]})}),e[94]=ge):ge=e[94],e[95]!==G||e[96]!==Z?(b=s.jsxs("div",{className:"mb-8 grid grid-cols-1 gap-6 md:grid-cols-4",children:[G,Z,ge]}),e[95]=G,e[96]=Z,e[97]=b):b=e[97],e[98]===Symbol.for("react.memo_cache_sentinel")?(j=s.jsx("h2",{className:"mb-6 text-2xl font-black text-slate-900",children:"État de la Caisse"}),e[98]=j):j=e[98],k="mb-10 grid grid-cols-1 gap-6 lg:grid-cols-3",F=U.map(fs),e[26]=Fe,e[27]=i,e[28]=t.closed_at,e[29]=t.id,e[30]=t.opened_at,e[31]=t.register?.name,e[32]=t.register?.shop?.name,e[33]=t.user?.name,e[34]=t.user_id,e[35]=S,e[36]=k,e[37]=F,e[38]=T,e[39]=p,e[40]=b,e[41]=j,e[42]=R,e[43]=g}else S=e[35],k=e[36],F=e[37],T=e[38],p=e[39],b=e[40],j=e[41],R=e[42],g=e[43];let D;e[99]!==k||e[100]!==F?(D=s.jsx("div",{className:k,children:F}),e[99]=k,e[100]=F,e[101]=D):D=e[101];let ce;e[102]===Symbol.for("react.memo_cache_sentinel")?(ce=s.jsx("h2",{className:"mb-6 text-2xl font-black text-slate-900",children:"Historique des Mouvements"}),e[102]=ce):ce=e[102];let de;e[103]===Symbol.for("react.memo_cache_sentinel")?(de=s.jsx(es,{children:s.jsxs(Ee,{children:[s.jsx(Ne,{children:"Heure"}),s.jsx(Ne,{children:"Type"}),s.jsx(Ne,{children:"Description"}),s.jsx(Ne,{children:"Montant"})]})}),e[103]=de):de=e[103];let H;e[104]!==o?(H=o.map(us),e[104]=o,e[105]=H):H=e[105];let E;e[106]!==o.length?(E=o.length===0&&s.jsx(Ee,{children:s.jsxs(te,{colSpan:4,className:"py-12 text-center text-slate-400",children:[s.jsx(as,{className:"mx-auto mb-3 h-12 w-12 text-slate-200"}),"Aucun mouvement enregistré pour cette session."]})}),e[106]=o.length,e[107]=E):E=e[107];let L;e[108]!==H||e[109]!==E?(L=s.jsx("div",{className:"rounded-3xl border border-slate-200/60 bg-white p-6 shadow-sm",children:s.jsxs(ss,{children:[de,s.jsxs(ts,{children:[H,E]})]})}),e[108]=H,e[109]=E,e[110]=L):L=e[110];let q;e[111]!==T||e[112]!==p||e[113]!==b||e[114]!==j||e[115]!==D||e[116]!==L?(q=s.jsxs("div",{className:T,children:[p,b,j,D,ce,L]}),e[111]=T,e[112]=p,e[113]=b,e[114]=j,e[115]=D,e[116]=L,e[117]=q):q=e[117];let me;e[118]===Symbol.for("react.memo_cache_sentinel")?(me=()=>se(!1),e[118]=me):me=e[118];let M;e[119]!==ke||e[120]!==_||e[121]!==t?(M=s.jsx(hs,{isOpen:_,onClose:me,session:t,onSuccess:ke}),e[119]=ke,e[120]=_,e[121]=t,e[122]=M):M=e[122];let xe;return e[123]!==S||e[124]!==R||e[125]!==g||e[126]!==q||e[127]!==M?(xe=s.jsxs(S,{currentPageName:R,children:[g,q,M]}),e[123]=S,e[124]=R,e[125]=g,e[126]=q,e[127]=M,e[128]=xe):xe=e[128],xe}function us(l){return s.jsxs(Ee,{children:[s.jsx(te,{className:"font-bold text-slate-500",children:Le(l.created_at).format("HH:mm")}),s.jsx(te,{children:s.jsx(Ce,{variant:"outline",className:"text-[10px] tracking-wider uppercase",children:l.type})}),s.jsx(te,{className:"font-medium text-slate-700",children:l.description}),s.jsx(te,{children:s.jsxs("span",{className:`font-black ${parseFloat(l.amount)<0?"text-red-500":"text-green-500"}`,children:[parseFloat(l.amount)>0?"+":"",l.amount," ",l.currency]})})]},l.id)}function fs(l){return s.jsxs(_e,{className:"overflow-hidden rounded-3xl border-slate-200/60 shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 bg-slate-50 px-6 py-4",children:[s.jsx("span",{className:"font-black text-slate-500",children:l.currency}),l.status==="perfect"&&s.jsxs(Ce,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:[s.jsx(ds,{className:"mr-1 h-3 w-3"})," ","OK"]}),l.status==="mismatch"&&s.jsxs(Ce,{className:"bg-red-100 text-red-700 hover:bg-red-100",children:[s.jsx(ms,{className:"mr-1 h-3 w-3"})," ","ÉCART"]})]}),s.jsxs(we,{className:"p-0",children:[s.jsxs("div",{className:"grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100",children:[s.jsxs("div",{className:"p-4",children:[s.jsx("p",{className:"text-xs font-bold text-slate-400 uppercase",children:"Ouverture"}),s.jsx("p",{className:"text-lg font-bold text-slate-700",children:l.opening.toFixed(2)})]}),s.jsxs("div",{className:"bg-slate-50/50 p-4",children:[s.jsx("p",{className:"text-xs font-bold text-slate-400 uppercase",children:"Théorique"}),s.jsx("p",{className:"text-lg font-bold text-slate-900",children:l.theoretical.toFixed(2)})]})]}),s.jsxs("div",{className:"grid grid-cols-2 divide-x divide-slate-100",children:[s.jsxs("div",{className:"p-4",children:[s.jsx("p",{className:"text-xs font-bold text-green-500 uppercase",children:"Entrées"}),s.jsxs("p",{className:"font-bold text-green-600",children:["+",l.totalIn.toFixed(2)]})]}),s.jsxs("div",{className:"p-4",children:[s.jsx("p",{className:"text-xs font-bold text-red-500 uppercase",children:"Sorties"}),s.jsxs("p",{className:"font-bold text-red-600",children:["-",l.totalOut.toFixed(2)]})]})]}),l.closingReal!==null&&s.jsx("div",{className:`border-t border-slate-100 p-4 ${Math.abs(l.difference)>.01?"bg-red-50":"bg-green-50"}`,children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase",children:"Réel (Compté)"}),s.jsx("p",{className:"text-xl font-black text-slate-900",children:l.closingReal.toFixed(2)})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase",children:"Écart"}),s.jsxs("p",{className:`text-xl font-black ${Math.abs(l.difference)>.01?"text-red-600":"text-green-600"}`,children:[l.difference>0?"+":"",l.difference.toFixed(2)]})]})]})})]})]},l.currency)}function ps(l,e){return l+Math.abs(parseFloat(e.amount))}function bs(l){return parseFloat(l.amount)<0}function js(l,e){return l+parseFloat(e.amount)}function gs(l){return parseFloat(l.amount)>0}export{Ks as default};
